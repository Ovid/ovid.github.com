

<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-BVDP76N9NB"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'G-BVDP76N9NB');
  </script>
  
  <!-- Facebook -->

  <meta property="fb:app_id" content="329861788447703" />
  
  
  <meta property="og:image" content="https://ovid.github.io/static/images/facebook/code.jpg" />
  <meta property="og:image:type" content="image/jpeg" />
  <meta property="og:image:alt" content="A laptop computer with Ruby on Rails code displayed on the monitor. Source: https://www.pexels.com/photo/black-and-gray-laptop-computer-546819/" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="https://ovid.github.io/articles/common-problems-in-object-oriented-code.html" />
  
  <meta property="og:title" content="Common Problems in Object-Oriented Code" />
  <meta property="og:description" content="At https://allaroundtheworld.fr/, we are often fixing common issues in object-oriented code. This is a practical guide for resolving them." />

  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">


  <!-- Basic Page Needs -->
  <meta charset="utf-8">
  <title>Common Problems in Object-Oriented Code</title>
  <meta name="description" content="Common Problems in Object-Oriented Code">
  <meta name="author" content="Curtis Poe">
  <link rel="alternate" type="application/rss+xml" title="Subscribe to my technical blog" href="https://ovid.github.io/article.rss" />
  <link rel="alternate" type="application/rss+xml" title="Subscribe to my personal blog" href="https://ovid.github.io/blog.rss" />

  <!-- Mobile Specific Metas -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- FONT -->
  <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">

  <!-- CSS -->
  <link rel="stylesheet" href="/static/css/normalize.css">
  <link rel="stylesheet" href="/static/css/skeleton.css">
  <link rel="stylesheet" href="/static/css/main.css">
  <link rel="stylesheet" href="/static/css/dialog.css">
  <link rel="stylesheet" href="/css/layout.css">
  <link rel="stylesheet" href="/static/css/image.css">
    <link rel="stylesheet" type="text/css" href="/static/css/prism.css"/> 
    

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="images/favicon.png">

</head>
<body>

  <!-- Primary Page Layout -->
  <div class="container">
    <div class="row books">
        <div class="twelve columns header">
            <ul>
              <li><a href="https://www.amazon.com/Perl-Hacks-Programming-Debugging-Surviving/dp/0596526741/" target="_blank"><img src="/static/images/perl-hacks.jpg" alt="The cover of the 'Perl Hacks' book" class="book"></a></li>
              <li><a href="https://www.amazon.com/Beginning-Perl-Curtis-Poe/dp/1118013840/" target="_blank"><img src="/static/images/beginning-perl.jpg" alt="The cover of the 'Beginning Perl' book" class="book"></a></li>
              <li><img class="book" src="/static/images/profile.png" alt="An image of Curtis Poe, holding some electronic equipment in front of his face."></li>
            </ul>
        </div>
    </div>
    <div class="row title">
        <!-- Back to top button -->
        <span aria-hidden="true"><a href="#top" class="arrow"><button id="scrollToTopButton">↑</button></a></span>
        <h1><a name="-title-no-title-found-"></a>Common Problems in Object-Oriented Code</h1>
        <time>2022-04-25</time>
        
        <p><span id="time"></span> minute read</p>
        
        <hr>
        <div class="twelve columns header">
        </div>
    </div>
    <div class="row">
      
      <div class="two columns">
          <span id="wasm_search"></span>
  <!-- Note the usage of `type=module` here as this is an ES6 module -->
  <script type="module">
    // Use ES module import syntax to import functionality from the module
    // that we have compiled.
    //
    // Note that the `default` import is an initialization function which
    // will "boot" the module and make it ready to use. Currently browsers
    // don't support natively imported WebAssembly as an ES module, but
    // eventually the manual initialization won't be required!
    // import { search, default as init } from './tinysearch_engine.js';
    import { search, default as init } from '/static/js/search/tinysearch_engine.js';
    window.search = search;

    async function run() {
      // First up we need to actually load the wasm file, so we use the
      // default export to inform it where the wasm file is located on the
      // server, and then we wait on the returned promise to wait for the
      // wasm to be loaded.
      //
      // Note that instead of a string here you can also pass in an instance
      // of `WebAssembly.Module` which allows you to compile your own module.
      // Also note that the promise, when resolved, yields the wasm module's
      // exports which is the same as importing the `*_bg` module in other
      // modes
      await init('/static/js/search/tinysearch_engine_bg.wasm');
    }

    run();
  </script>

  <script>
    // And afterwards we can use all the functionality defined in wasm.
    function doSearch() {
      let value = document.getElementById("demo").value;
      console.log(`Search query: ${value}`);

      const results = search(value, 5);

      console.log(`Results: ${results}`);

      let ul = document.getElementById("results");
      ul.innerHTML = "";

      for (i = 0; i < results.length; i++) {
        var li = document.createElement("li");

        let [title, url] = results[i];
        let elemlink = document.createElement('a');
        elemlink.innerHTML = title;
        elemlink.setAttribute('href', url);
        li.appendChild(elemlink);

        ul.appendChild(li);
      }
    }
	// https://stackoverflow.com/questions/47879864/how-can-i-check-if-a-browser-supports-webassembly#:~:text=There%20are%20a%20few%20ways,js).
	const wasm_supported = (() => {
		try {
			if (typeof WebAssembly === "object"
				&& typeof WebAssembly.instantiate === "function") {
				const module = new WebAssembly.Module(Uint8Array.of(0x0, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00));
				if (module instanceof WebAssembly.Module)
					return new WebAssembly.Instance(module) instanceof WebAssembly.Instance;
			}
		} catch (e) {
		}
		return false;
	})();
    if (!wasm_supported) {
      // don't even show them the search box if they don't have web assembly
      // document.getElementById("wasm_search").innerHTML = "Your browser does not support WebAssembly. Please use a modern browser.";
    }
    else {
      document.getElementById("wasm_search").innerHTML = '<div id="search"><strong>Search</strong><input type="text" id="demo" onkeyup="doSearch()"><ul id="results"></ul><div><hr>';
    }
  </script>

        <ul>
          <li><a href="/index.html">Home</a></li>
          <li><a href="/articles.html">Articles</a> <a href="/article.rss"><img border="0" alt="Subscribe to Articles by Ovid" src="/static/images/rss.png" width="12" height="12"/></a></li>
          <li><a href="/blog.html">Blog</a> <a href="/blog.rss"><img border="0" alt="Subscribe to Blogs by Ovid" src="/static/images/rss.png" width="12" height="12"/></a></li>
          <li><a href="/videos.html">Talks</a></li>
          <li><a href="/hireme.html">Hire Me</a></li>
          <li><a href="/wildagile.html">WildAgile</a></li>
          <!-- <li><a href="/tau-station.html">Tau Station</a></li> -->
          <li><a href="/starmap.html">Starmap</a></li>
          <li><a href="/escape.html"><strong>Escape!</strong></a></li>
        </ul>
        <hr>
        <strong>Find me on ...</strong>
        <ul>
          <li><a href="https://www.linkedin.com/in/curtispoe/">LinkedIn</a></li>
          <li><a href="https://github.com/Ovid/">GitHub</a></li>
          <li><a href="https://fosstodon.org/@ovid" rel="me">Mastodon</a></li>
          <li><a href="https://bsky.app/profile/ovid.bsky.social">Bluesky</a></li>
        </ul>
        <strong>Tags</strong>
        <ul class="cloud" role="navigation" aria-label="Tag cloud for Ovid's site">
        
            <li><a href="/tags/programming.html" data-weight="9">Software</a></li>
        
            <li><a href="/tags/business.html" data-weight="6">Business</a></li>
        
            <li><a href="/tags/oop.html" data-weight="5">OOP</a></li>
        
            <li><a href="/tags/perl.html" data-weight="5">Perl</a></li>
        
            <li><a href="/tags/ai.html" data-weight="4">AI</a></li>
        
            <li><a href="/tags/corinna.html" data-weight="4">Corinna</a></li>
        
            <li><a href="/tags/databases.html" data-weight="3">Databases</a></li>
        
            <li><a href="/tags/personal.html" data-weight="3">Personal</a></li>
        
            <li><a href="/tags/politics.html" data-weight="3">Politics</a></li>
        
            <li><a href="/tags/space.html" data-weight="3">Space</a></li>
        
            <li><a href="/tags/writing.html" data-weight="3">Writing</a></li>
        
            <li><a href="/tags/family.html" data-weight="2">Family</a></li>
        
            <li><a href="/tags/math.html" data-weight="2">Math</a></li>
        
            <li><a href="/tags/science.html" data-weight="2">Science</a></li>
        
            <li><a href="/tags/expat.html" data-weight="1">Moving Abroad</a></li>
        
        </ul>
      </div>

        <div class="ten columns verticalLine article">

        <div class="prevNext">
        
        <a href="/articles/why-is-object-oriented-programming-bad.html" class="prevPost">&laquo; Why is Object-Oriented Programming Bad?</a>
        
        <a href="/articles/introducing-moosexextended-for-perl.html" class="nextPost">Introducing MooseX::Extended for Perl &raquo;</a>
    </div>

    

<ul class="inline" role="navigation" aria-label="Tag list for this articles">
    <li>Tags:</li>

    <li><a href="/tags/corinna.html">Corinna</a> </li>

    <li><a href="/tags/oop.html">OOP</a> </li>

    <li><a href="/tags/perl.html">Perl</a> </li>

    <li><a href="/tags/programming.html">Software</a> </li>

</ul>


        <hr>
    <!-- nada -->



<article id="article">
<p><nav role="navigation" class="table-of-contents">
    <ul>
    <li class="indent-1"><a href="#preface">Preface</a></li>
    <li class="indent-1"><a href="#whats-an-object">What’s an Object?</a></li>
    <li class="indent-1"><a href="#recommendations">Recommendations</a></li>
    <li class="indent-2"><a href="#immutable-objects">Immutable Objects</a></li>
    <li class="indent-3"><a href="#recommendation">Recommendation</a></li>
    <li class="indent-2"><a href="#small-interfaces-and-encapsulation">Small Interfaces and Encapsulation</a></li>
    <li class="indent-3"><a href="#recommendation-2">Recommendation</a></li>
    <li class="indent-2"><a href="#type-library">Type Library</a></li>
    <li class="indent-3"><a href="#recommendation-3">Recommendation</a></li>
    <li class="indent-2"><a href="#subclassing">Subclassing</a></li>
    <li class="indent-3"><a href="#recommendation-4">Recommendation</a></li>
    <li class="indent-2"><a href="#performance">Performance</a></li>
    <li class="indent-3"><a href="#recommendation-5">Recommendation</a></li>
    <li class="indent-1"><a href="#problems">Problems</a></li>
    <li class="indent-2"><a href="#too-many-responsibilities">Too Many Responsibilities</a></li>
    <li class="indent-3"><a href="#recommendation-6">Recommendation</a></li>
    <li class="indent-2"><a href="#use-methods-for-attribute-data">Use Methods for Attribute Data</a></li>
    <li class="indent-3"><a href="#recommendation-7">Recommendation</a></li>
    <li class="indent-2"><a href="#confusing-subroutines-and-methods">Confusing Subroutines and Methods</a></li>
    <li class="indent-3"><a href="#recommendation-8">Recommendation</a></li>
    <li class="indent-2"><a href="#inconsistent-return-types">Inconsistent Return Types</a></li>
    <li class="indent-3"><a href="#recommendation-9">Recommendation</a></li>
    <li class="indent-2"><a href="#ignored-constructor-arguments">Ignored Constructor Arguments</a></li>
    <li class="indent-3"><a href="#recommendation-10">Recommendation</a></li>
    <li class="indent-1"><a href="#leftovers">Leftovers</a></li>
    <li class="indent-1"><a href="#dr-frankenstein">Dr. Frankenstein</a></li>
    <li class="indent-1"><a href="#hire-us">Hire Us</a></li>
    </ul>
</nav>
<hr></p>

<h1><a name="preface"></a>Preface</h1>

<p>After spending almost three years as the lead designer of the <a href="https://github.com/Ovid/Cor" target="_blank">Corinna
object system for the Perl core</a> <span class="fa fa-external-link fa_custom"></span>, I’m delighted
that work on including this in the Perl language will start soon.
Until it’s there, <a href="https://allaroundtheworld.fr/" target="_blank">our company</a> <span class="fa fa-external-link fa_custom"></span> still does a lot
of work with clients, fixing their object-oriented code (OOP) and we’ve seen
some very common causes of failures. Some say that our recommendations are too
strict, and for personal projects, they might be. But we work with large-scale
codebases, often written in Perl, and often containing over a million lines of
code. When you’re working at that scale, especially when coordinating with many
developers who may not know your code well, you need to be more rigorous.</p>

<p>This is not a tutorial on OOP design. That in itself is a complex topic
(and perhaps one of the strongest arguments against OOP). So we’ll assume you
need to fix an existing OOP codebase rather than design a new one.</p>

<p>Note: while these examples are in Perl, many of these problems apply to
codebases we’ve worked on in other OO languages.</p>

<p><strong>Warning</strong>: whenever we link to a module on the CPAN, please read the 
documentation of that module if you decide to use it. There are often caveats, 
such as with the “strict constructor” modules we mention later.</p>

<h1><a name="whats-an-object"></a>What’s an Object?</h1>

<p>First and foremost, we must keep in mind what an object is. <a href="/articles/why-is-object-oriented-programming-bad.html">This is covered
more in other
articles</a>, but for this
one, just keep in mind that an object is an expert about a particular topic.
Forget all of those other explanations about objects being “structs with
behavior”, or “a reference to a data type that knows what class it belongs to.”
Those are implementation details that don’t tell you objects are <em>for</em>. In my
opinion, they even hinder people’s understanding of objects because they keep
you focused on the wrong thing. Objects are experts on a particular problem
space, that’s all.</p>

<h1><a name="recommendations"></a>Recommendations</h1>

<p>We could talk about <a href="https://en.wikipedia.org/wiki/SOLID" target="_blank">SOLID</a> <span class="fa fa-external-link fa_custom"></span>,
<a href="https://en.wikipedia.org/wiki/GRASP_(object-oriented_design)" target="_blank">GRASP</a> <span class="fa fa-external-link fa_custom"></span>, the
<a href="https://en.wikipedia.org/wiki/Liskov_substitution_principle" target="_blank">Liskov substitution
principle</a> <span class="fa fa-external-link fa_custom"></span>, the
<a href="https://en.wikipedia.org/wiki/Law_of_Demeter" target="_blank">Law of Demeter</a> <span class="fa fa-external-link fa_custom"></span>, and so on, but
while those are important, you can read about those on your own. Instead, we’ll
cover recommendations and common problems. You’ll need to use your best judgment
to decide how (or if) they apply to your codebase.</p>

<blockquote>
  <p>Note: if this article makes your eyes glaze over, but you love the Moose OOP
  system, you might skip ahead to <a href="#dr-frankenstein">Dr.  Frankenstein</a> to see a
  small module built on top of Moose that implements some of the recommendations
  in this article.</p>
</blockquote>

<h2><a name="immutable-objects"></a>Immutable Objects</h2>

<p>I’ve written before why <a href="/articles/using-immutable-datetime-objects-with-dbixclass.html">immutable objects are
good</a>, so I
won’t go into too much detail. Sometimes it’s not practical to have immutable
objects (e.g., caches), but immutability should be your <em>default</em> position. In
most languages, objects are passed by reference, not value. The more widely
used an instance of your object is, if it’s mutable, the more likely that code
“A” will change the state in a way that code “B” didn’t expect.</p>

<h3><a name="recommendation"></a>Recommendation</h3>

<p>Even if you’re not convinced, try writing and using immutable objects. Like
anything new, it can take some getting used to, but there’s a payoff there. Just
don’t insist that everything be immutable. Your colleagues will hate you.</p>

<p>Note that if your object must return references to data, those are often
mutable. However, you can declare those as immutable, too.</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">package Some::Class {
    use Const::Fast 'const';

    # set up data here

    sub get_data_structure {
        my $self = shift;
        const my %hash =&gt; (
            name     =&gt; $self-&gt;name,
            giggity  =&gt; $self-&gt;_something_else,
        );
        return \%hash;
    }
}
</code></pre></div>

<p>In the above, the <code>get_data_structure</code> method returns an immutable data
structure. Attempts to access unknown hash keys or change any of the values is a
fatal error (use <code>exists</code> to test hash keys, of course). Some people call it
overkill.  Others call it safety. Your mileage may vary.</p>

<p>If you prefer, you can deeply clone the data structure before returning it. By
presenting a copy, different consumers calling that method will always have the
same results, but if the returned reference itself is shared, you could have
issues. That being said, this is an issue with all code, not just OOP.</p>

<h2><a name="small-interfaces-and-encapsulation"></a>Small Interfaces and Encapsulation</h2>

<p>The interface that your class presents is your “contract” with everyone who uses
your class. You should design that interface with care, but you shouldn’t expose
what you don’t need to. Using one of my “go to” examples of the Corinna OOP
system that will be available in upcoming releases (but not in the immediate
future), here’s a basic LRU (least recently used) cache:</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">class Cache::LRU {
    use Hash::Ordered;

    field $cache    :handles(exists) { Hash::Ordered-&gt;new };
    field $max_size :param :reader   { 20 };

    method set ( $key, $value ) {
        if ( $cache-&gt;exists($key) ) {
            $cache-&gt;delete($key);
        }
        elsif ( $cache-&gt;keys &gt;= $max_size ) {
            $cache-&gt;shift;
        }
        $cache-&gt;set( $key, $value );  # add to front
    }

    method get ($key) {
        if ( $cache-&gt;exists($key) ) {
            my $value = $cache-&gt;get($key);
            $self-&gt;set( $key, $value ); # add to front
            return $value;
        }
        return;
    }
}
</code></pre></div>

<p>With the popular Moose OOP system for Perl, that would look something like this
(skipping the sub bodies):</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">package Cache::LRU {
    use Moose;
    use Hash::Ordered;
    use namespace::autoclean;

    has '_cache' =&gt; (
        is       =&gt; 'ro',
        init_arg =&gt; undef,
        default  =&gt; sub { Hash::Ordered-&gt;new },
    );

    has 'max_size' =&gt; ( is =&gt; 'ro', default =&gt; 20 );

    sub set {
        ...
    }

    sub get {
        ...
    }

    __PACKAGE__-&gt;meta-&gt;make_immutable;
}

</code></pre></div>

<p>For raw Perl, it might even look like this:</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">package Cache::LRU;

use strict;
use warnings;
use Hash::Ordered;

sub new {
    my ( $class, $max_size ) = @_;
    $max_size //= 20;
    return bless {
        max_size =&gt; $max_size,
        _cache   =&gt; Hash::Ordered-&gt;new,
    }, $class;
}

# more code here
</code></pre></div>

<p>For both Moose and core Perl, it’s hard to encapsulate your objects and minimize
your interface. For both of those, you can call <code>$object-&gt;{_cache}</code> to get the
underlying cache. For Moose, you can also call <code>$object-&gt;_cache</code> (it’s very
cumbersome in Moose or Moo to not expose methods for what should be private
data).  This means that you have exposed that data, no matter how nicely you’ve
asked people to “stay out of the kitchen.” This means that if someone is
accessing your “private” data, if you want to switch your internal cache to use
Redis, SQLite, or something else, you can easily break the code of others who
are relying on it.</p>

<p>We almost always see <code>$object-&gt;_private_method</code> or <code>$object-&gt;{private_data}</code> in
client codebases and that’s one of the first things we try to fix, if we have
time. As a class author, you need to know you can safely change the internals of
your object.</p>

<h3><a name="recommendation-2"></a>Recommendation</h3>

<p>Keep your classes as small as you can and stop making accessors public by
default. For now, this means prefixing methods with an underscore to make them
“private by convention.” With Corinna, you simply don’t provide <code>:reader</code> or
<code>:writer</code> attributes:</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">class Cache::LRU {
    use Hash::Ordered;

    field $cache                   { Hash::Ordered-&gt;new };
    field $max_size :param :reader { 20 };
    ...
</code></pre></div>

<p>In the above, you can read (but not write) the max size, but there’s no direct
access possible to the <code>$cache</code> (this will be possible via the MOP, the
meta-object protocol, but we do not want violating encapsulation to be a natural
default. Hitting the MOP to violate encapsulation will stand out like a coal
pile in a ballroom in code reviews).</p>

<blockquote>
  <p>Note: some Perl developers use “inside-out” objects to enforce
  encapsulation. The CPAN has
  <a href="https://metacpan.org/pod/Object::InsideOut" target="_blank">Object::InsideOut</a> <span class="fa fa-external-link fa_custom"></span> and
  <a href="https://metacpan.org/pod/Class::InsideOut" target="_blank">Class::InsideOut</a> <span class="fa fa-external-link fa_custom"></span>, amongst others.
  While it’s easy to use instances of these classes, they were cumbersome to write
  and sometimes buggy. As a result, we do not experience them often in client
  code.</p>
</blockquote>

<h2><a name="type-library"></a>Type Library</h2>

<p>As systems grow, it’s very easy to have this problem:</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">sub get_part_by_id ($self, $id) {
    return $self-&gt;_inventory_schema-&gt;resultset('Part')-&gt;find($id);
}
</code></pre></div>

<p>Most of the time that works, but sometimes you get no result. What happened?
Maybe your primary key is a UUID but you’ve supplied an integer? Oops. So now
you have to rewrite that:</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">sub get_part_by_id ($self, $id) {
    unless ( $id =~ qr/^[0-9a-f]{8}(?:-[0-9a-f]{4}){2}-[0-9a-f]{12}$/is ) {
        croak(&quot;ID ($id) does not look like a UUID.&quot;);
    }
    return $self-&gt;_inventory_schema-&gt;resultset('Part')-&gt;find($id);
}
</code></pre></div>

<p>Do you really want to write that? Do you really want to debug that? (there’s a
small bug in that example, if you care to look for it). If you use UUIDs
frequently, you don’t want to write that again.</p>

<p>If you’ve used Moose, you know how easy it is to use type constraints:</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">has 'order_items' =&gt; (
    is     =&gt; 'ro',
    isa    =&gt; 'ArrayRef[HashRef]',
    writer =&gt; '_set_order_items',
);
</code></pre></div>

<p>Of course, if you spell the <code>isa</code> as <code>ArrayRef[HasRef]</code>, you won’t find out
until runtime that you’ve misspelled it. For these and other situations, just
create a type library as a centralized place to put your types and share them
across your codebase as needed. If there’s too much code, focus on critical
paths first.</p>

<h3><a name="recommendation-3"></a>Recommendation</h3>

<p>Creating a type library for the first time can be daunting. Here’s a simple one,
based on the excellent <a href="https://metacpan.org/pod/Type::Tiny" target="_blank">Type::Tiny</a> <span class="fa fa-external-link fa_custom"></span> by Toby
Inkster. It will cover most of your basic needs and you can extend it later with
custom types, if needed.</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">package My::Personal::Types;

use strict;
use warnings;
use Type::Library -base;
use Type::Utils -all;
use Type::Params; # this gets us compile and compile_named

our @EXPORT_OK;

BEGIN {
    # this gets us most of our types
    extends qw(
      Types::Standard
      Types::Common::Numeric
      Types::Common::String
      Types::UUID
    );
    push @EXPORT_OK =&gt; (
        'compile',
        'compile_named',
    );
}

1;
</code></pre></div>

<p>Using it is simple.</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">use My::Personal::Types qw(compile UUID);

sub get_part_by_id ($self, $id) {
    state $check = compile(UUID);
    ($id) = $check-&gt;($id);
    return $self-&gt;_inventory_schema-&gt;resultset('Part')-&gt;find($id);
}
</code></pre></div>

<p>In Moose, use these constraints to turn misspelled types into
compile-time failures (and to get a much richer set of allowed types):</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">use My::Personal::Types qw(ArrayRef HashRef);

has 'order_items' =&gt; (
    is     =&gt; 'ro',
    isa    =&gt; ArrayRef [HashRef],
    writer =&gt; '_set_order_items',
);
</code></pre></div>

<p>Despite the <code>Type::Tiny</code> name, <a href="https://metacpan.org/dist/Type-Tiny/view/lib/Type/Tiny/Manual.pod" target="_blank">the manual is quite
extensive</a> <span class="fa fa-external-link fa_custom"></span>.
Go there for more information.</p>

<h2><a name="subclassing"></a>Subclassing</h2>

<p>A subclass of a class is intended to be a more specialized version of that
class. A <code>Car isa Vehicle</code>, or a <code>Human isa Mammal</code>. However, it’s easy to get
this wrong under the pressure of deadlines, complex code bases, or just plain
not paying attention. Is <code>Item isa Product</code> correct? Or is <code>Product isa Item</code>
more correct?</p>

<p>Ultimately, the problem manifests itself in what I call the “person/invoice
problem”: <code>Person isa Invoice</code>. That makes absolutely no sense, but <em>your
software doesn’t know that</em>. Your software only does what you tell it to do. It
can’t evaluate semantics (at least, not yet), and if you write code that runs,
but doesn’t make sense, that’s too bad.</p>

<p>In fact, inheritance is so problematic that some OOP languages disallow it
altogether, favoring composition instead. Some only allow single inheritance,
but provide alternatives (mixins, interfaces, traits, etc.). As a general rule,
we recommend you use roles instead of parent classes:</p>

<ul>
<li><a href="https://metacpan.org/pod/Role::Tiny" target="_blank">Role::Tiny</a> <span class="fa fa-external-link fa_custom"></span> (for any OO code)</li>
<li><a href="https://metacpan.org/pod/Moose::Role" target="_blank">Moose::Role</a> <span class="fa fa-external-link fa_custom"></span> (for Moose)</li>
<li><a href="https://metacpan.org/pod/Moo::Role" target="_blank">Moo::Role</a> <span class="fa fa-external-link fa_custom"></span> (for Moo)</li>
</ul>

<p>There’s also my own <a href="https://metacpan.org/pod/Role::Basic" target="_blank">Role::Basic</a> <span class="fa fa-external-link fa_custom"></span> which
can be used where <code>Role::Tiny</code> is appropriate, but <a href="https://metacpan.org/dist/Role-Basic/view/lib/Role/Basic/Philosophy.pod" target="_blank">the philosophy of that
module is
different</a> <span class="fa fa-external-link fa_custom"></span>
and presents somewhat different features.</p>

<p>Sometimes inheritance is the right thing to do. For example, in the
<a href="https://metacpan.org/pod/Test::Class::Moose" target="_blank">Test::Class::Moose</a> <span class="fa fa-external-link fa_custom"></span> xUnit
framework, we have “test control methods” which run code before the class is
instantiated, before each method is run, after each method is run, and after the
test class has finished running. A <code>test_setup</code> method might look like this:</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">sub test_setup {
   my $test = shift;
   $test-&gt;next::method;
   $test-&gt;load_fixtures(qw/Customer Orders/);
}
</code></pre></div>

<p>In the above example, the <code>$test-&gt;next::method</code> is used to call the parent
<code>test_setup</code> to ensure that all setup is ready before you try to handle this
class’s setup. In fact, you might have your <code>test_setup</code> call a parent
<code>test_setup</code> which in turns calls <em>its</em> parent <code>test_setup</code>. This is common in
xUnit testing and the order in which events fire is important. With roles, this
is often done with method modifiers, but the order in which they fire is often
dependent on their load order and that is <em>not</em> guaranteed. If you find yourself
frequently using method modifiers in roles, you might want to think about
inheritance to ensure that you have complete control over the sequencing of
commands.</p>

<h3><a name="recommendation-4"></a>Recommendation</h3>

<p>We should prefer composition or roles over inheritance. Composition is good when
you clearly have an object to delegate to. Roles are good when you have some
behavior which might apply to unrelated classes (such as serialization to JSON
or XML).</p>

<p>There’s much more we could say about roles, but a full tutorial is beyond the
scope of this article.</p>

<h2><a name="performance"></a>Performance</h2>

<p>Don’t stress about performance, really. It’s not the code. It’s the database.
It’s always the database.  Unless it’s the network. Or it’s disk I/O. Or, or, or
...</p>

<p>Steve McConnell, in his fantastic book Code Complete, 2nd edition, writes:</p>

<blockquote>
  <p>It’s almost impossible to identify performance bottlenecks before a program is
  working completely. Programmers are very bad at guessing which four percent of
  the code accounts for 50 percent of the execution time, and so programmers who
  optimize as they go will, on average, spend 96 percent of their time
  optimizing code that doesn’t need to be optimized. That leaves little time to
  optimize the four percent that really counts.</p>
</blockquote>

<p>Unless you know, at design time, you’ll have performance critical code (don’t
write ray-tracing software in Perl, folks!), design a great system and worry
about performance only when it’s proven to be an actual problem.
<a href="https://metacpan.org/pod/Devel::NYTProf" target="_blank">Devel::NYTProf</a> <span class="fa fa-external-link fa_custom"></span> is your friend here.
Be aware that benchmarking can be an arcane art.</p>

<p>But when we talk about performance, whose performance are we talking about? The
software or the software developer? Here’s a little benchmark for you:</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">#!/usr/bin/env perl

use strict;
use warnings;
use Benchmark 'cmpthese';

sub use_a_loop {
    my @numbers;
    foreach my $i ( 0 .. 9 ) {
        $numbers[$i] = $i / ( $i + 1 );
    }
    return \@numbers;
}

sub direct_assignment {
    my @numbers;
    $numbers[0] = 0 / 1;
    $numbers[1] = 1 / 2;
    $numbers[2] = 2 / 3;
    $numbers[3] = 3 / 4;
    $numbers[4] = 4 / 5;
    $numbers[5] = 5 / 6;
    $numbers[6] = 6 / 7;
    $numbers[7] = 7 / 8;
    $numbers[8] = 8 / 9;
    $numbers[9] = 9 / 10;
    return \@numbers;
}

cmpthese(
    1_000_000,
    {
        'use_a_loop'        =&gt; \&amp;use_a_loop,
        'direct_assignment' =&gt; \&amp;direct_assignment,
    }
);
</code></pre></div>

<p>Do you think the loop or the direct assignment is faster? Do you really care?
Well, it should be pretty clear that the loop is much easier to maintain. The
direct assignment, however ...</p>

<div class="shadow"><pre class="scrolled"><code>                       Rate        use_a_loop direct_assignment
use_a_loop         970874/s                --              -50%
direct_assignment 1923077/s               98%                --
</code></pre></div>

<p>Whoa! Directly assigning the data is twice as fast as the loop! If something
like that is at the bottom of a tight loop and benchmarking shows that it’s a
performance issue, then yes, switching from a loop to direct assignment might be
an idea, but that would kill <em>developer</em> performance when it comes to
maintaining that code. If you must do that, document it carefully, perhaps
including a snippet of the code that this replaces.</p>

<h3><a name="recommendation-5"></a>Recommendation</h3>

<p>Design the system well and don’t worry about performance while building it.
Doing so runs the risk of optimizing code that doesn’t need to be optimized and
possibly makes the code harder to maintain, raising long-term costs.</p>

<p>Instead, if your code is suffering performance issues, benchmark your code and
find out where the real problems are. Here’s a video of Tim Bunce explaining how
to profile your code:</p>

<div class="video-responsive">
    <iframe width="560" height="315" src="https://www.youtube.com/embed/SDWoCQf53Ck" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div>

<h1><a name="problems"></a>Problems</h1>

<p>The above were general recommendations for OO code, but now let’s talk about
common problems we encounter with our clients.</p>

<h2><a name="too-many-responsibilities"></a>Too Many Responsibilities</h2>

<p>For our <a href="/articles/project-500.html">Project 500</a> contract, our client was
providing online credit card services for a major, well-publicized event.
However, they had a serious problem: their code could only handle 39 credit card
transactions per second per server. For this event, they had a contractual 
obligation to improve performance by an <strong>order of magnitude</strong>. That’s right; 
they were required to have their code run at least ten times faster. We had two 
weeks to develop a proof of concept (spoiler: we succeeded).</p>

<p>In digging in, it turns out that they had developed an in-house OO system and an
in-house ORM. We quickly discovered that a single “charge $x to the credit card”
transaction generated almost 200 calls to the database! This was one of their
major bottlenecks.</p>

<p>For our client’s ORM, every time a request was made it would gather a
bunch of metadata, check permissions, make decisions based on whether or not
it was using Oracle or PostgreSQL, check to see if the data was cached, and
<em>then</em> check to see if the data was in the database. Instantiating
every object was very slow, even if there was no data available. And the code
was creating—and throwing away without using—hundreds of these
objects per request.</p>

<p>We considered using a “pre-flight” check to see if the data was in the database
before creating the objects, but there was so much business logic
embedded in the ORM layer that this was not a practical solution given our time 
constrain. And we couldn’t simply fetch the data directly because, again, the 
ORM had too many non-ORM responsibilities built into it.</p>

<p>On another system, we had an immutable object (yay!) that had disk I/O
and heavy data validation every time it was instantiated. Yet that data never
changed between releases, so I was tasked with caching the object data. I
restructured to class to separate the validation of instance data and the
setting of instance data. Then I added a few lines of code to the class to
handle this and it worked like a charm, but my tests missed an edge case where
<em>some</em> data wasn’t cached properly because one bit of data was set during
validation. I had made the classic mistake of putting too much logic in that
class.</p>

<p>To address this, I built a simple class to properly cache objects on web server 
restart and it cached the object for me. Not only did it work right this time, I 
now had a flexible in-memory cache for other objects. Further, because the cache 
internals were encapsulated, if we want to switch the cache out for Redis or 
something else, it becomes trivial.<span aria-label="Open Footnote" class="open-dialog" id="open-dialog-1"> <i class="fa fa-clipboard fa_custom"></i> </span>.</p>

<h3><a name="recommendation-6"></a>Recommendation</h3>

<p>Don’t have your objects try to do too much. The “single-responsibility”
principle generally means there should only be a single reason to change a
class. In the real-world, this is easy to miss, but it will save you much grief
if you get this right.</p>

<h2><a name="use-methods-for-attribute-data"></a>Use Methods for Attribute Data</h2>

<p>In old-school OOP code for Perl, you might see something like this:</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">package Customer;

use strict;
use warnings;
use Carp 'croak';

sub new {
    my ( $class, $name, $title ) = @_;
    croak(&quot;Name required&quot;) unless defined $name;
    return bless {
        name  =&gt; $name,
        title =&gt; $title,
    }, $class;
}

sub name  { $_[0]-&gt;{name} }
sub title { $_[0]-&gt;{title} }

# more code here

1;
</code></pre></div>

<p>So far, so good. But the business rules state that if the customer has a title,
they must always be referred to by both their title and name, never just one or
the other. Developers keep forgetting (or don’t know) this business rule, but 
remember: your object is supposed to be the expert here and it won’t get it 
wrong, so the object should handle this responsibility.</p>

<p>Now you’re rewritten the class to remover the <code>title</code> accessor and to provide a
<code>name</code> method to encapsulate this logic:</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">package Customer;

use strict;
use warnings;
use Carp 'croak';

sub new {
    my ( $class, $name, $title ) = @_;
    croak(&quot;Name required&quot;) unless defined $name;
    return bless {
        name  =&gt; $name,
        title =&gt; $title,
    }, $class;
}

# always prefix their name with a title if it exists
sub name {
    my $self = shift;
    return $self-&gt;{title}
        ? &quot;$self-&gt;{title} $self-&gt;{name}&quot;
        : $self-&gt;{name};
}

# more code here

1;
</code></pre></div>

<p>Again, this code looks correct, but by eliminating the accessor for our <code>title</code>
attribute, if we were forced to subclass this, how do we override it, especially
if it’s used elsewhere in the class? We <em>could</em> just overwrite the <code>name</code> and
<code>title</code> values in the blessed hash of the subclass and that might be good
enough, but if we need to convert an attribute to a method—as we did with <code>name</code>
we can’t easily do that now.</p>

<h3><a name="recommendation-7"></a>Recommendation</h3>

<p>This is one of the advantages of Moose and Moo. You automatically get method
accessors for data attributes, so users of those OO systems will rarely notice
this unless they also get in the bad habit of doing <code>$self-&gt;{title}</code>.</p>

<p>Otherwise, if you’re writing core Perl, just include simple accessors/mutators
for your data (prefacing them with a leading underscore if they should be 
private):</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">sub title ($self) {
    return $self-&gt;{title};
}

sub set_title ($self, $title) {
    $self-&gt;{title} = $title;
}
</code></pre></div>

<p>Whether you prefer to overload a method to be both an accessor and a mutator, or
to return the invocant on mutation are arguments that are far beyond the scope
of this article, so we would recommend following the current style of your
codebase. If it doesn’t exist, define it and stick to it (predictable interfaces
are fantastic!).</p>

<h2><a name="confusing-subroutines-and-methods"></a>Confusing Subroutines and Methods</h2>

<p>Your Moose/Moo classes should generally resemble the following:</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">package Some::Class {
    use Moose;
    use namespace::autoclean;

    # class definition here

    # make_immutable is a significant performance boost
    __PACKAGE__-&gt;meta-&gt;make_immutable;
}
</code></pre></div>

<p>I was writing some client software that could cache some objects (it’s a
coincidence that I’ve had to do this so often) and for one edge case,
it was good if we could clone the objects first. Many things cannot be easily
cloned, so if the object provides its own <code>clone</code> method, we used that instead
of simply returning the object from the cache. It looked sort of like this:</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">sub fetch ( $class, %arg_for ) {
    my $object = $class-&gt;_fetch_for_identifier(
      $arg_for{identifier}
    );
    if ($object) {
        return $object-&gt;can('clone')
            ? $object-&gt;clone 
            : $object;
    }
    else {
        return $class-&gt;_instantiate_and_cache($arg_for);
    }
}
</code></pre></div>

<p>That failed miserably because some objects were importing a <code>clone</code> subroutine
and because Perl doesn’t have a distinction because subroutines and methods
(though it will when Corinna is implemented), <code>clone</code> was in the
namespace and the <code>can('clone')</code> method returned true. We tried to call a
subroutine as a method, even though it wasn’t.</p>

<h3><a name="recommendation-8"></a>Recommendation</h3>

<p>Using <a href="https://metacpan.org/pod/namespace::autoclean" target="_blank">namespace::autoclean</a> <span class="fa fa-external-link fa_custom"></span> or
<a href="https://metacpan.org/pod/namespace::clean" target="_blank">namespace::clean</a> <span class="fa fa-external-link fa_custom"></span> will remove the
imported subroutines from the namespace and make it much harder for code to call
subroutines as methods. Read the documentation for each to decide which will
work better for you.</p>

<p>Note that as of this writing, there is an outstanding RFC for Perl to allow a
lexical importing mechanism which should make this less of a problem in the
future if it’s adopted.</p>

<h2><a name="inconsistent-return-types"></a>Inconsistent Return Types</h2>

<p>This isn’t just an OOP problem, but it’s a common issue we see in code in 
dynamic languages, so it’s worth mentioning here. If you’re going to return an 
array reference or a hash reference, you usually want to ensure that’s <em>all</em> you 
return. For example:</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">my $results = $object-&gt;get_results;
if ($results) {
    foreach my $result ($result-&gt;@*) {
        # do something
    }
}
</code></pre></div>

<p>But what if you forget the <code>if</code>?</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">my $results = $object-&gt;get_results;
foreach my $result ($result-&gt;@*) {
    # do something
}
</code></pre></div>

<p>If <code>get_results</code> returns <code>undef</code> when there are no results, the code blows up.
However, if it returns an empty array reference, the loop is simply skipped.
You don’t have to remember to check the return value type (unless returning
nothing is an actual error).  This is easy to fix in methods, but be wary of a
similar trap with attributes:</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">has 'results' =&gt; (
    is  =&gt; 'ro',
    isa =&gt; Maybe[ ArrayRef ],
);
</code></pre></div>

<h3><a name="recommendation-9"></a>Recommendation</h3>

<p>There are several ways to handle this, including defining coerced types, but
one of the simplest and safest:</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">has 'results' =&gt; (
    is      =&gt; 'ro',
    isa     =&gt; ArrayRef,
    default =&gt; sub { [] },
);
</code></pre></div>

<p>In the above, we drop the <code>Maybe</code> and default to an array reference if no
argument is supplied to the constructor. With that, if they pass an arrayref of
hashrefs for <code>results</code>, it works. If they <em>don’t</em> pass <code>results</code> at all, it
still works.</p>

<p>However, if they pass anything else for <code>results</code>, including <code>undef</code>, it fails. 
That’s great safety because while you want the types you return to be 
predictable, it’s also good to allow the types you pass in to be predictable. 
There are definitely exceptions to this, but they should be used with care.</p>

<h2><a name="ignored-constructor-arguments"></a>Ignored Constructor Arguments</h2>

<p>Going back to our <code>results</code> example:</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">package Some::Class;
use Moose;

has 'results' =&gt; (
    is      =&gt; 'ro',
    isa     =&gt; ArrayRef,
    default =&gt; sub { [] },
);
</code></pre></div>

<p>What happens if we do <code>my $object = Some::Class-&gt;new( result =&gt; $result );</code>.</p>

<p>No matter what the type of <code>$result</code> is, the value is thrown away because by
default, Moose and Moo simply discard unknown arguments to the constructor. If
you misspell a constructor argument, this can be a frustrating source of errors.</p>

<h3><a name="recommendation-10"></a>Recommendation</h3>

<p>Fortunately, the fix for this is simple, too:
<a href="https://metacpan.org/pod/MooseX::StrictConstructor" target="_blank">MooseX::StrictConstructor</a> <span class="fa fa-external-link fa_custom"></span>. <br />
(Or <a href="https://metacpan.org/pod/MooX::StrictConstructor" target="_blank">MooX::StrictConstructor</a> <span class="fa fa-external-link fa_custom"></span> 
for Moo):</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">package Some::Class;
use Moose;
use MooseX::StrictConstructor;

has 'results' =&gt; (
    is      =&gt; 'ro',
    isa     =&gt; ArrayRef,
    default =&gt; sub { [] },
);
</code></pre></div>

<p>Now, passing unknown arguments is a fatal error.</p>

<p>If you’re using traditional <code>bless</code> syntax, you’ll have to manually validate the
arguments to the constructor yourself, but the type library we outlined above
can be used.</p>

<h1><a name="leftovers"></a>Leftovers</h1>

<p>There’s a huge amount more we can say, including useful design patters,
being cautious with method modifiers in roles, when to use abstract classes
instead of roles, but we’re starting to get into the long tail of code smells in
object-oriented code bases, so perhaps those are good for another article.</p>

<h1><a name="dr-frankenstein"></a>Dr. Frankenstein</h1>

<p>If you’ve gotten this far, congrats! One thing very helpful with OO code is to
develop a set of guidelines on how you’ll build OO code and stick to it. We’re
going to be Dr. Frankenstein and build our own object system out of the parts we
have laying around. By ensuring everyone uses this object system, we can have
greater consistency in our code.</p>

<p>Let’s pretend you’ve settled on the Moose OOP system as the basis of your own.
You’d like to ensure several things are true and you’ve come up with the
following list:</p>

<ul>
<li>Unknown arguments to the constructor are fatal</li>
<li>It should be easy to see which attributes are or are not required in the
constructor</li>
<li>Attributes should default to read-only</li>
<li><code>namespace::autoclean</code> must always be used</li>
<li>You want signatures and types</li>
<li>The <code>Carp</code> module’s <code>carp</code>, <code>croak</code>, and <code>confess</code> functions should always be
present</li>
<li>You want the C3 MRO (though you should avoid multiple inheritance)</li>
<li>Your work uses v5.22, so you’ll enforce those features</li>
</ul>

<p>For this, you’ve decided that <code>param</code> should replace <code>has</code> if the parameter is
required in the constructor, and <code>field</code> should replace <code>has</code> if the parameter
is not allowed in the constructor. Let’s use
<a href="https://metacpan.org/pod/Moose::Exporter" target="_blank">Moose::Exporter</a> <span class="fa fa-external-link fa_custom"></span> to set this up.</p>

<p>We won’t explain how all of this works, so you have some homework to do.</p>

<blockquote>
  <p>Again, we’re not saying the above is what you <strong>should</strong> do; we’re just giving
  an example of what you <strong>can</strong> do.</p>
</blockquote>

<div class="shadow"><pre class="scrolled"><code class="language-perl">package My::Personal::Moose;

use v5.22.0;
use Moose                     ();
use MooseX::StrictConstructor ();
use Moose::Exporter;
use mro                  ();
use feature              ();
use namespace::autoclean ();
use Import::Into;
use Carp qw/carp croak confess/;

Moose::Exporter-&gt;setup_import_methods(
    with_meta =&gt; [ 'field', 'param' ],
    as_is     =&gt; [ \&amp;carp, \&amp;croak, \&amp;confess ],
    also      =&gt; ['Moose'],
);

sub init_meta {
    my ( $class, @args ) = @_;
    my %params    = @args;
    my $for_class = $params{for_class};
    Moose-&gt;init_meta(@args);
    MooseX::StrictConstructor-&gt;import( { into =&gt; $for_class } );
    warnings-&gt;unimport('experimental::signatures');
    feature-&gt;import(qw/signatures :5.22/);
    namespace::autoclean-&gt;import::into($for_class);

    # If we never use multiple inheritance, this should not be needed.
    mro::set_mro( scalar caller(), 'c3' );
}

sub field {
    my ( $meta, $name, %opts ) = @_;

    # default to read-only
    $opts{is} //= 'ro';

    # &quot;has [@attributes]&quot; versus &quot;has $attribute&quot;
    foreach my $attr ( 'ARRAY' eq ref $name ? @$name : $name ) {
        my %options = %opts;    # copy each time to avoid overwriting

        # forbid setting `field` in the constructor
        $options{init_arg} = undef;
        $meta-&gt;add_attribute( $attr, %options );
    }
}

sub param {
    my ( $meta, $name, %opts ) = @_;

    # default to read-only
    $opts{is}       //= 'ro';

    # it's required unless they tell us otherwise
    $opts{required} //= 1;

    # &quot;has [@attributes]&quot; versus &quot;has $attribute&quot;
    foreach my $attr ( 'ARRAY' eq ref $name ? @$name : $name ) {
        my %options = %opts;    # copy each time to avoid overwriting

        if ( exists $options{init_arg} &amp;&amp; !defined $options{init_arg} ) {
            croak(&quot;You may not set init_arg to undef for 'param'&quot;);
        }
        $meta-&gt;add_attribute( $attr, %options );
    }
}

1;
</code></pre></div>

<p>With that, and the <code>My::Personal::Types</code> above, here’s a (silly) example of how
to use this:</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">#!/usr/bin/env perl

use lib 'lib';
use Test::Most;

package My::Names {
    use My::Personal::Moose;
    use My::Personal::Types qw(
      compile
      Num
      NonEmptyStr
      Str
      PositiveInt
      ArrayRef
    );

    use List::Util 'sum'; # removed my namespace::autoclean

    param _name   =&gt; ( isa =&gt; NonEmptyStr, init_arg =&gt; 'name' );
    param title   =&gt; ( isa =&gt; Str,         required =&gt; 0 );
    field created =&gt; ( isa =&gt; PositiveInt, default  =&gt; sub { time } );

    sub name ($self) {
        my $title = $self-&gt;title;
        my $name  = $self-&gt;_name;
        return $title ? &quot;$title $name&quot; : $name;
    }

    sub add ( $self, $args ) {
        state $check = compile( ArrayRef [Num] );
        ($args) = $check-&gt;($args);
        carp(&quot;no numbers supplied to add()&quot;) unless $args-&gt;@*;
        return sum( $args-&gt;@* );
    }

    __PACKAGE__-&gt;meta-&gt;make_immutable;
}

my $person = My::Names-&gt;new( name =&gt; 'Ovid', );
is $person-&gt;name, 'Ovid', 'name should be correct';
ok !defined $person-&gt;title, '... and no title';
cmp_ok $person-&gt;created, '&gt;', 0, '... and a sane default for created';
ok !$person-&gt;can('sum'), 'subroutines have been removed from the namespace';
is $person-&gt;add( [qw/1 3 5 6/] ), 15, 'Our add() method should work';
throws_ok { My::Names-&gt;new( name =&gt; 'Ovid', created =&gt; 1 ) }
'Moose::Exception',
  'Attributes not defined as `param` are illegal in the constructor';

my $doctor = My::Names-&gt;new( name =&gt; 'Smith', title =&gt; 'Dr.' );
is $doctor-&gt;name,        'Dr. Smith', 'Titles should show up correctly';
cmp_ok $doctor-&gt;created, '&gt;=',        $person-&gt;created,
  '... and their created date should be correct';

done_testing;
</code></pre></div>

<p>Obviously, the above code probably won’t be fit for purpose, but it shows you 
the basics of how you can build an OO system to fit your company’s needs, rather 
than allowing everyone to just “do their own thing.”</p>

<h1><a name="hire-us"></a>Hire Us</h1>

<p>We do code reviews, development, testing, and design, focused on reliability and
scalability. Even if you’re just exploring possibilities, feel free to <a href="mailto:info@allaroundtheworld.fr?subject=Consulting">contact
us</a> and let’s see what we
can do to make your software better.</p>

</article>



          <p><strong>Please leave a comment below!</strong></p>



<script type="text/javascript">
    // estimated reading time
    // via https://dev.to/michaelburrows/calculate-the-estimated-reading-time-of-an-article-using-javascript-2k9l

    function readingTime() {
        const text  = document.getElementById("article").innerText;

        // The average eighth grader in the US reads about 250 words a minute, but your average
        // university student reads at almost twice that speed. However, my technical articles
        // are more in-depth and can take some time to think about, so be fair to the reader
        // and assume they'll take a bit longer for that.
        const wpm   = "articles" === "articles" ? 250 : 350;
        const words = text.trim().split(/\s+/).length;
        const time  = Math.ceil(words / wpm);
        document.getElementById("time").innerText = time;
    }
    readingTime();
</script>

<!-- map images pop up when you click them -->
<div id="overlay" class="overlay">
    <img id="overlayImage" src="" alt="Full-size image">
</div>
<script>
    function showOverlay(img) {
        const overlay = document.getElementById('overlay');
        const overlayImage = document.getElementById('overlayImage');
        overlayImage.src = img.src;
        overlayImage.alt = img.alt;
        overlay.style.display = 'block';
    }

    function hideOverlay() {
        const overlay = document.getElementById('overlay');
        overlay.style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', function() {
        const images = document.querySelectorAll('.image-container img');
        images.forEach(img => {
            img.addEventListener('click', function() {
                showOverlay(this);
            });
        });

        const overlay = document.getElementById('overlay');
        overlay.addEventListener('click', hideOverlay);
    });
</script>

<hr>
    <div class="prevNext">
        
        <a href="/articles/why-is-object-oriented-programming-bad.html" class="prevPost">&laquo; Why is Object-Oriented Programming Bad?</a>
        
        <a href="/articles/introducing-moosexextended-for-perl.html" class="nextPost">Introducing MooseX::Extended for Perl &raquo;</a>
    </div>

<hr>

          <p>If you'd like top-notch consulting or training, <a
          href="mailto:curtis.poe@gmail.com">email me</a> and let's discuss
          how I can help you. Read my <a href="/hireme.html">hire me</a> page
          to learn more about my background.</p>
        </div>
    </div>
<!-- End Document
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <div class="row">
      <div class="two columns">
        <p></p>
      </div>
      <div class="ten columns">
        <hr>
        <p>Copyright &copy; 2018-2025 by Curtis “Ovid” Poe.</p>
      </div>
    </div>
        <div id="disqus_thread"></div>
    <div class="row">
      <div class="twelve columns">
      
        <script>
        var disqus_config = function () {
            this.page.url        = "https://ovid.github.io/articles/common-problems-in-object-oriented-code.html";
            this.page.identifier = "articles/common-problems-in-object-oriented-code";
            this.page.title      = "Common Problems in Object-Oriented Code";
        };
        (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://https-ovid-github-io.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
        })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      
        </div>
    </div>
    </div>
    
    <script src="/static/js/prism.js"></script>
    
	
    <!-- footnotes https://bitsofco.de/accessible-modal-dialog/ -->
    <div class="dialog-overlay" tabindex="-1"></div>
    
    <script type="text/javascript" src="/static/js/Dialog.js"></script>
	  
            <div id="dialog-1" class="dialog" role="dialog" aria-labelledby="note-1" aria-describedby="note-description-1">
        <strong id="note-1">Footnotes</strong>
        <p id="note-description-1" class="sr-only">Note number 1</p>
	    <div>I should have used <a 
href="https://metacpan.org/pod/CHI">CHI</a>.</div>
        <button type="button" aria-label="Close Navigation" class="close-dialog" id="close-dialog-1"> <i class="fa fa-times"></i> </button>
    </div>

    <script>
        var dialogOverlay = document.querySelector('.dialog-overlay');
        var myDialog1 = new Dialog(document.querySelector('#dialog-1'), dialogOverlay);
        myDialog1.addEventListeners('#open-dialog-1', '#close-dialog-1');
    </script>
      
    
</body>
</html>


