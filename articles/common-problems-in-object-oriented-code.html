

<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Facebook -->

  <meta property="fb:app_id" content="329861788447703" />
  
  <meta property="og:image" content="https://ovid.github.io/static/images/facebook/ovid-facebook.jpg" />
  <meta property="og:image:alt" content="A black and white image of the author, Curtis “Ovid” Poe." />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="https://ovid.github.io/articles/common-problems-in-object-oriented-code.html" />
  
  <meta property="og:title" content="Common Problems in Object-Oriented Code" />
  <meta property="og:description" content="At https://allaroundtheworld.fr/, we are often fixing common issues in object-oriented code. This is a practical guide for resolving them." />

  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-129723079-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-129723079-1');
  </script>


  <!-- Basic Page Needs -->
  <meta charset="utf-8">
  <title>Common Problems in Object-Oriented Code</title>
  <meta name="description" content="Common Problems in Object-Oriented Code">
  <meta name="author" content="Curtis Poe">
  <link rel="alternate" type="application/rss+xml" title="Subscribe to my technical blog" href="https://ovid.github.io/article.rss" />
  <link rel="alternate" type="application/rss+xml" title="Subscribe to my personal blog" href="https://ovid.github.io/blog.rss" />

  <!-- Mobile Specific Metas -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- FONT -->
  <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">

  <!-- CSS -->
  <link rel="stylesheet" href="/static/css/normalize.css">
  <link rel="stylesheet" href="/static/css/skeleton.css">
  <link rel="stylesheet" href="/static/css/main.css">
  <link rel="stylesheet" href="/static/css/dialog.css">
  <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" type="text/css" href="/static/css/prism.css"/> 
    

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="images/favicon.png">

</head>
<body>

  <!-- Primary Page Layout -->
  <div class="container">
    <div class="row books">
        <div class="twelve columns header">
			<ul>
			<li><a
            href="https://www.amazon.com/Perl-Hacks-Programming-Debugging-Surviving/dp/0596526741/"
            target="_blank"><img src="/static/images/perl-hacks.jpg"
            alt="The cover of the 'Perl Hacks' book" class="book"></a></li>
			<li><a
            href="https://www.amazon.com/Beginning-Perl-Curtis-Poe/dp/1118013840/"
            target="_blank"><img src="/static/images/beginning-perl.jpg"
            alt="The cover of the 'Beginning Perl' book" class="book"></a></li>
			<li><img class="book" src="/static/images/profile.png" alt="An
            image of Curtis Poe, holding some electronic equipment in front of
            his face."></li>
			</ul>
        </div>
    </div>
    <div class="row title">
        <!-- Back to top button -->
        <span aria-hidden="true"><a href="#top" class="arrow"><button id="scrollToTopButton">↑</button></a></span>
        <h1><a name="-title-no-title-found-"></a>Common Problems in Object-Oriented Code</h1>
        <time>2022-04-17</time>
        <hr>
        <div class="twelve columns header">
        </div>
    </div>
    <div class="row">
      
      <div class="three columns">
        <ul>
          <li><a href="/index.html">Home</a></li>
          <li><a href="/articles.html">Technical Articles</a> <a href="/article.rss"><img border="0" alt="Subscribe to Articles by Ovid" src="/static/images/rss.png" width="12" height="12"/></a></li>
          <li><a href="/blog.html">Blog</a> <a href="/blog.rss"><img border="0" alt="Subscribe to Blogs by Ovid" src="/static/images/rss.png" width="12" height="12"/></a></li>
          <li><a href="/hireme.html">Hire Me</a></li>
          <li><a href="/publicspeaking.html">Public Speaking</a></li>
          <li><a href="/wildagile.html">WildAgile</a></li>
          <li><a href="/tau-station.html">Tau Station</a></li>
          <li><a href="/starmap.html">Starmap</a></li>
        </ul>
        <hr>
        <strong>Find me on ...</strong>
        <ul>
          <li><a href="https://twitter.com/OvidPerl">Twitter</a></li>
          <li><a href="https://github.com/Ovid/">GitHub</a></li>
          <li><a href="https://www.linkedin.com/in/curtispoe/">LinkedIn</a></li>
        </ul>
        <hr>
        <strong>Tags</strong>
        <ul class="cloud" role="navigation" aria-label="Tag cloud for Ovid's site">
        
            
            
            <li><a href="/tags/business.html" data-weight="9">Business</a></li>
        
            
            
            <li><a href="/tags/corinna.html" data-weight="6">Corinna</a></li>
        
            
            
            <li><a href="/tags/databases.html" data-weight="8">Databases</a></li>
        
            
            
            <li><a href="/tags/family.html" data-weight="4">Family</a></li>
        
            
            
            <li><a href="/tags/math.html" data-weight="4">Math</a></li>
        
            
            
            <li><a href="/tags/oop.html" data-weight="9">OOP</a></li>
        
            
            
            <li><a href="/tags/perl.html" data-weight="7">Perl</a></li>
        
            
            
            <li><a href="/tags/personal.html" data-weight="3">Personal</a></li>
        
            
            
            <li><a href="/tags/politics.html" data-weight="5">Politics</a></li>
        
            
            
            <li><a href="/tags/programming.html" data-weight="9">Programming</a></li>
        
            
            
            <li><a href="/tags/space.html" data-weight="3">Space</a></li>
        
            
            
            <li><a href="/tags/writing.html" data-weight="7">Writing</a></li>
        
        </ul>
      </div>

        <div class="nine columns verticalLine article">

        <div class="prevNext">
        
        <a href="/articles/why-is-object-oriented-programming-bad.html" class="prevPost">&laquo; Why is Object-Oriented Programming Bad?</a>
        
        <a href="/#" class="nextPost"></a>
    </div>

    

<ul class="inline" role="navigation" aria-label="Tag list for this articles">
    <li>Tags:</li>

    <li><a href="/tags/corinna.html">Corinna</a> </li>

    <li><a href="/tags/oop.html">OOP</a> </li>

    <li><a href="/tags/perl.html">Perl</a> </li>

    <li><a href="/tags/programming.html">Programming</a> </li>

</ul>


        <hr>
    <blockquote> We're hiring experienced Perl developers for full-time
<em>remote</em> contracts on a number of projects. If you are interested, <a
href="mailto:curtis.poe@gmail.com">email me</a>. We also have one potential
role for an experienced Python developer with OpenAPI + ORM experience.
</blockquote> 

<hr/>



<p><nav role="navigation" class="table-of-contents">
    <ul>
    <li class="indent-1"><a href="#whats-an-object">What’s an Object?</a></li>
    <li class="indent-1"><a href="#recommendations">Recommendations</a></li>
    <li class="indent-2"><a href="#immutable-objects">Immutable Objects</a></li>
    <li class="indent-3"><a href="#recommendation">Recommendation</a></li>
    <li class="indent-2"><a href="#small-interfaces-and-encapsulation">Small Interfaces and Encapsulation</a></li>
    <li class="indent-3"><a href="#recommendation-2">Recommendation</a></li>
    <li class="indent-2"><a href="#type-library">Type Library</a></li>
    <li class="indent-3"><a href="#recommendation-3">Recommendation</a></li>
    <li class="indent-2"><a href="#subclassing">Subclassing</a></li>
    <li class="indent-3"><a href="#recommendation-4">Recommendation</a></li>
    <li class="indent-2"><a href="#performance">Performance</a></li>
    <li class="indent-3"><a href="#recommendation-5">Recommendation</a></li>
    <li class="indent-1"><a href="#problems">Problems</a></li>
    <li class="indent-2"><a href="#too-many-responsibilities">Too many responsibilities</a></li>
    <li class="indent-2"><a href="#immutable">Immutable</a></li>
    <li class="indent-2"><a href="#accessors-for-attributes">accessors for attributes</a></li>
    <li class="indent-2"><a href="#namespaceautoclean-and-make-immutable">namespace::autoclean and make_immutable</a></li>
    <li class="indent-2"><a href="#consistent-return-types">Consistent return types</a></li>
    <li class="indent-2"><a href="#strict-constructor">Strict constructor</a></li>
    <li class="indent-2"><a href="#small-interfaces">Small interfaces</a></li>
    <li class="indent-2"><a href="#roles">Roles</a></li>
    <li class="indent-1"><a href="#dr-frankenstein">Dr. Frankenstein</a></li>
    </ul>
</nav>
<hr></p>

<p>After spending almost three years as the lead designer of the <a href="https://github.com/Ovid/Cor" target="_blank">Corinna
object system for the Perl core</a> <span class="fa fa-external-link fa_custom"></span>, I’m quite
delighted that work on including this in the Perl language will start soon.
Until it’s there, <a href="https://allaroundtheworld.fr/" target="_blank">our company</a> <span class="fa fa-external-link fa_custom"></span> still does lot
of work with object-oriented code (OOP) and we’ve seen some very common causes
of failures.  Much of what follows deals with the issues we’ve had with client
code, so this is a practical guide.</p>

<p>This is not an exhaustive list of best practices, but it covers many common
problems and offers tips for avoiding these problems. Note that much of what
follows are rules of thumb, not absolute laws.</p>

<h1><a name="whats-an-object"></a>What’s an Object?</h1>

<p>First and foremost, we must keep in mind what an object is. <a href="/articles/why-is-object-oriented-programming-bad.html">I cover this a
bit more in-depth in other
articles</a>, but for this
one, just keep in mind that an object is an expert about a particular topic.
Forget all of those other explanations about objects being “structs with
behavior”, or “a reference to a data type that knows what class it belongs to.”
Those are implementation details that don’t tell you objects are <em>for</em>. Objects
are experts on a particular problem space, that’s all.</p>

<h1><a name="recommendations"></a>Recommendations</h1>

<p>I could talk about <a href="https://en.wikipedia.org/wiki/SOLID" target="_blank">SOLID</a> <span class="fa fa-external-link fa_custom"></span>,
<a href="https://en.wikipedia.org/wiki/GRASP_(object-oriented_design)" target="_blank">GRASP</a> <span class="fa fa-external-link fa_custom"></span>, the
<a href="https://en.wikipedia.org/wiki/Liskov_substitution_principle" target="_blank">Liskov substitution
principle</a> <span class="fa fa-external-link fa_custom"></span>, the
<a href="https://en.wikipedia.org/wiki/Law_of_Demeter" target="_blank">Law of Demeter</a> <span class="fa fa-external-link fa_custom"></span>, and so on, but
while those are important, you can read about those on your own. Instead, I’ll
get right to the heart of many common issues.</p>

<h2><a name="immutable-objects"></a>Immutable Objects</h2>

<p>I’ve written before why <a href="/articles/using-immutable-datetime-objects-with-dbixclass.html">immutable objects are
good</a>, so I
won’t go into too much detail. Sometimes it’s not practical to have immutable
objects (e.g., caches), but immutability should be your <em>default</em> position. In
most languages, objects are passed by reference, not values. The more widely
used an instance of your object is, if it’s mutable, the more likely that code
“A” will change the state in a way that code “B” didn’t expect.</p>

<h3><a name="recommendation"></a>Recommendation</h3>

<p>Even if you’re not convinced, try writing and using immutability objects. Like
anything new, it can take some getting used to, but there’s a payoff there. Just
don’t insist that everything be immutable. Your colleagues will hate you.</p>

<p>Note that if your object must return references to data, those are often
mutable. However, you can declare those as immutable, too.</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">package Some::Class {
    use Const::Fast 'const';

    # set up data here

    sub get_data_structure {
        my $self = shift;
        const my %hash =&gt; (
            name     =&gt; $self-&gt;name,
            giggity  =&gt; $self-&gt;_something_else,
        );
        return \%hash;
    }
}
</code></pre></div>

<p>In the above, the <code>get_data_structure</code> method returns an immutable data
structure. Attempts to access unknown hash keys or change any of the values is a
fatal error (use <code>exists</code> to test hash keys, of course). Some people call it
overkill.  Others call it safety. Your mileage may vary.</p>

<p>If you prefer, you can deeply clone the data structure before returning it. By
presenting a copy, different consumers calling that method will always have the
same results, but if the returned reference itself is shared, you could have
issues. That being said, this is an issue with any large-scale code, not just
OOP.</p>

<h2><a name="small-interfaces-and-encapsulation"></a>Small Interfaces and Encapsulation</h2>

<p>The interface that your class presents is your “contract” with everyone who uses
your class. You should design that interface with care, but you shouldn’t expose
what you don’t need to. Using one of my “go to” examples of Corinna code that
will be available in upcoming releases (but not in the immediate future), here’s
an LRU (least recently used) cache:</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">class Cache::LRU :version(v0.1.0) {
    use Hash::Ordered;

    field $cache                   { Hash::Ordered-&gt;new };
    field $max_size :param :reader { 20 };

    method set ( $key, $value ) {
        if ( $cache-&gt;exists($key) ) {
            $cache-&gt;delete($key);
        }
        elsif ( $cache-&gt;keys &gt; $max_size ) {
            $cache-&gt;shift;
        }
        $cache-&gt;set( $key, $value );  # add to front
    }

    method get ($key) {
        if ( $cache&gt;exists($key) ) {
            my $value = $cache-&gt;get($key);
            $self-&gt;set( $key, $value ); # add to front
            return $value;
        }
        return;
    }
}
</code></pre></div>

<p>With the popular Moose OOP system for Perl, that would look something like this
(skipping the sub bodies):</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">package Cache::LRU {
    use Moose;
    use Hash::Ordered;
    use namespace::autoclean;

    has '_cache' =&gt; (
        is       =&gt; 'ro',
        init_arg =&gt; undef,
        default  =&gt; sub { Hash::Ordered-&gt;new },
    );

    has 'max_size' =&gt; ( is =&gt; 'ro', default =&gt; 20 );

    sub set {
        ...
    }

    sub get {
        ...
    }

    __PACKAGE__-&gt;meta-&gt;make_immutable;
}

</code></pre></div>

<p>For raw Perl, it might even look like this:</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">package Cache::LRU;

use strict;
use warnings;
use Hash::Ordered;

sub new {
    my ( $class, $max_size ) = @_;
    $max_size //= 20;
    return bless {
        max_size =&gt; $max_size,
        _cache   =&gt; Hash::Ordered-&gt;new,
    }, $class;
}

# more code here
</code></pre></div>

<p>For both Moose and core Perl, it’s hard to encapsulate your objects and minimize
your interface. For both of those, you can call <code>$object-&gt;{_cache}</code> to get the
underlying cache. For Moose, you can also call <code>$object-&gt;_cache</code> (it’s very
cumbersome in Moose or Moo to not offer private methods for private data).  This
means that you have exposed that data, no matter how nicely you’ve asked people
to “stay out of the kitchen.” This means that later on, if you want to switch
your internal cache to use Redis, SQLite, you can easily break the code of
others who are relying on it.</p>

<p>We almost always see <code>$object-&gt;_private_method</code> or <code>$object-&gt;{private_data}</code> in
client codebases and that’s one of the first things we try to fix, if we have
time. As a class author, you need to know you can safely change the internals of
your object.</p>

<h3><a name="recommendation-2"></a>Recommendation</h3>

<p>Keep your classes as small as you can and stop making accessors public by
default. For now, this means prefixing methods with an underscore to make them
“private by convention.” With Corinna, you simply don’t provide <code>:reader</code> or
<code>:writer</code> attributes:</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">class Cache::LRU :version(v0.1.0) {
    use Hash::Ordered;

    field $cache                   { Hash::Ordered-&gt;new };
    field $max_size :param :reader { 20 };
    ...
</code></pre></div>

<p>In the above, you can read (but not write) the max size, but there’s no direct
access possible to the <code>$cache</code> (this will be possible via the MOP, the
meta-object protocol, but we want violating encapsulation to be a natural
default).</p>

<blockquote>
  <p>Note: some Perl developers still use “inside-out” objects to enforce
  encapsulation. The CPAN has
  <a href="https://metacpan.org/pod/Object::InsideOut" target="_blank">Object::InsideOut</a> <span class="fa fa-external-link fa_custom"></span> and
  <a href="https://metacpan.org/pod/Class::InsideOut" target="_blank">Class::InsideOut</a> <span class="fa fa-external-link fa_custom"></span>, amongst others.
  While it’s easy to use instances of these classes, they were cumbersome to write
  and sometimes buggy.</p>
</blockquote>

<h2><a name="type-library"></a>Type Library</h2>

<p>As systems grow, it’s very easy to have this problem:</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">sub get_part_by_id ($self, $id) {
    return $self-&gt;_inventory_schema-&gt;resultset('Part')-&gt;find($id);
}
</code></pre></div>

<p>Most of the time that works, but sometimes you get no result. What happened?
Maybe your primary key is a UUID but you’ve supplied an integer? Oops. So now
you have to rewrite that:</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">sub get_part_by_id ($self, $id) {
    unless ( $id =~ qr/^[0-9a-f]{8}(?:-[0-9a-f]{4}){2}-[0-9a-f]{12}$/is ) {
        croak(&quot;ID ($id) does not look like a UUID.&quot;);
    }
    return $self-&gt;_inventory_schema-&gt;resultset('Part')-&gt;find($id);
}
</code></pre></div>

<p>Do you really want to write that? Do you really want to debug that? (I
deliberately added a bug). If you use UUIDs frequently, you don’t want to write
that again.</p>

<p>If you’ve used Moose, you know how easy it is to use type constraints:</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">has 'order_items' =&gt; (
    is     =&gt; 'ro',
    isa    =&gt; 'ArrayRef[HashRef]',
    writer =&gt; '_set_order_items',
);
</code></pre></div>

<p>Of course, if you spell the <code>isa</code> as <code>ArrayRef[HasRef]</code>, you won’t find out
until runtime that you’ve misspelled it. For these and other situations, just
create a type library as a centralized place to put your types and share them
across your codebase as needed. If there’s too much code, focus on critical
paths first.</p>

<h3><a name="recommendation-3"></a>Recommendation</h3>

<p>Creating a type library for the first time can be daunting. Here’s a simple one,
based on the excellent <a href="https://metacpan.org/pod/Type::Tiny" target="_blank">Type::Tiny</a> <span class="fa fa-external-link fa_custom"></span> by Toby
Inkster. It will cover most of your basic needs and you can extend it later with
custom types, if needed.</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">package My::Personal::Types;

use strict;
use warnings;
use Type::Library -base;
use Type::Utils -all;
use Type::Params; # this gets us compile and compile_named

our @EXPORT_OK;

BEGIN {
    # this gets us most of our types
    extends qw(
      Types::Standard
      Types::Common::Numeric
      Types::Common::String
      Types::UUID
    );
    push @EXPORT_OK =&gt; (
        'compile',
        'compile_named',
    );
}

1;
</code></pre></div>

<p>Using it is simple.</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">use My::Personal::Types qw(compile UUID);
sub get_part_by_id ($self, $id) {
    state $check = compile(UUID);
    ($id) = $check-&gt;($id);
    return $self-&gt;_inventory_schema-&gt;resultset('Part')-&gt;find($id);
}
</code></pre></div>

<p>And in Moose, use these constraints to turn misspelled types into
compile time failures (and to get a much richer set of allowed types):</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">use My::Personal::Types qw(ArrayRef HashRef);
has 'order_items' =&gt; (
    is     =&gt; 'ro',
    isa    =&gt; ArrayRef [HashRef],
    writer =&gt; '_set_order_items',
);
</code></pre></div>

<p>Despite the <code>Type::Tiny</code> name, <a href="https://metacpan.org/dist/Type-Tiny/view/lib/Type/Tiny/Manual.pod" target="_blank">the manual is quite
extensive</a> <span class="fa fa-external-link fa_custom"></span>.
Go there for more information.</p>

<h2><a name="subclassing"></a>Subclassing</h2>

<p>A subclass of a class is intended to be a more specialized version of that
class. A <code>Car isa Vehicle</code>, or a <code>Human isa Mammal</code>. However, it’s easy to get
this wrong under the pressure of deadlines, complex code bases, or just plain
not paying attention. Is <code>Item isa Product</code> correct? Or is <code>Product isa Item</code>
more correct?</p>

<p>Ultimately, the problem manifests itself in what I call the “person/invoice
problem”: <code>Person isa Invoice</code>. That makes absolutely no sense, but <em>your
software doesn’t know that</em>. Your software only does what you tell it to do. It
can’t evaluate semantics (at least, not yet), and if you write code that runs,
but doesn’t make sense, that’s too bad.</p>

<p>In fact, inheritance is so problematic that some OOP languages disallow it
altogether, favoring composition instead. Some only allow single inheritance,
but provide alternatives (mixins, interfaces, traits, etc.). As a general rule,
we recommend you use roles instead of parent classes:</p>

<ul>
<li><a href="https://metacpan.org/pod/Role::Tiny" target="_blank">Role::Tiny</a> <span class="fa fa-external-link fa_custom"></span> (for any OO code)</li>
<li><a href="https://metacpan.org/pod/Moose::Role" target="_blank">Moose::Role</a> <span class="fa fa-external-link fa_custom"></span> (for Moose)</li>
<li><a href="https://metacpan.org/pod/Moo::Role" target="_blank">Moo::Role</a> <span class="fa fa-external-link fa_custom"></span> (for Moo)</li>
</ul>

<p>There’s also my own <a href="https://metacpan.org/pod/Role::Basic" target="_blank">Role::Basic</a> <span class="fa fa-external-link fa_custom"></span> which
can be used where <code>Role::Tiny</code> is appropriate, but <a href="https://metacpan.org/dist/Role-Basic/view/lib/Role/Basic/Philosophy.pod" target="_blank">the philosophy of that
module is
different</a> <span class="fa fa-external-link fa_custom"></span>
and presents somewhat different features.</p>

<p>Sometimes inheritance is the right thing to do. For example, in the
<a href="https://metacpan.org/pod/Test::Class::Moose" target="_blank">Test::Class::Moose</a> <span class="fa fa-external-link fa_custom"></span> xUnit
framework, we have “test control methods” which run code before the class is
instantiated, before each method is run, after each method is run, and after the
test class has finished running. A <code>test_setup</code> method might look like this:</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">sub test_setup {
   my $test = shift;
   $test-&gt;next::method;
   $test-&gt;load_fixtures(qw/Customer Orders/);
}
</code></pre></div>

<p>In the above example, the <code>$test-&gt;next::method</code> is used to call the parent
<code>test_setup</code> to ensure that all setup is ready before you try to call your
setup. In fact, you might have your <code>test_setup</code> call a parent <code>test_setup</code>
which in turns calls <em>its</em> parent <code>test_setup</code>. This is common in xUnit testing
and the order in which events fire is important. With roles, this is often done
with method modifiers, but the order in which they fire is often dependent on
their load order and that is <em>not</em> guaranteed. If you find yourself using lots
of method modifiers in roles, you might want to think about inheritance to
ensure that you have complete control over the sequencing of commands.</p>

<h3><a name="recommendation-4"></a>Recommendation</h3>

<p>We should prefer composition or roles over inheritance. Composition is good when
you clearly have an object to delegate to. Roles are good when you have some
behavior which might apply to unrelated classes (such as serialization to JSON
or XML).</p>

<p>There’s a lot more we could say about roles, but a full tutorial is beyond the
scope of this article.</p>

<h2><a name="performance"></a>Performance</h2>

<p>Don’t stress about performance, really. It’s not the code. It’s the database. Or
it’s the network. Or it’s disk I/O. Or, or, or ...</p>

<p>Steve McConnell, in his fantastic book Code Complete, 2nd edition, writes:</p>

<blockquote>
  <p>It’s almost impossible to identify performance bottlenecks before a program is
  working completely. Programmers are very bad at guessing which four percent of
  the code accounts for 50 percent of the execution time, and so programmers who
  optimize as they go will, on average, spend 96 percent of their time
  optimizing code that doesn’t need to be optimized. That leaves little time to
  optimize the four percent that really counts.</p>
</blockquote>

<p>Unless you know, at design time, you’ll have performance critical code (don’t
write ray-tracing software in Perl, folks!), design a great system and worry
about performance only when it’s proven to be a real problem.
<a href="https://metacpan.org/pod/Devel::NYTProf" target="_blank">Devel::NYTProf</a> <span class="fa fa-external-link fa_custom"></span> is your friend here.
Be aware that benchmarking can be an arcane art.</p>

<p>But when we talk about performance, whose performance are we talking about? The
software or the software developer? Here’s a little benchmark for you:</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">#!/usr/bin/env perl

use strict;
use warnings;
use Benchmark 'cmpthese';

sub use_a_loop {
    my @numbers;
    foreach my $i ( 0 .. 9 ) {
        $numbers[$i] = $i / ( $i + 1 );
    }
    return \@numbers;
}

sub direct_assignment {
    my @numbers;
    $numbers[0] = 0 / 1;
    $numbers[1] = 1 / 2;
    $numbers[2] = 2 / 3;
    $numbers[3] = 3 / 4;
    $numbers[4] = 4 / 5;
    $numbers[5] = 5 / 6;
    $numbers[6] = 6 / 7;
    $numbers[7] = 7 / 8;
    $numbers[8] = 8 / 9;
    $numbers[9] = 9 / 10;
    return \@numbers;
}

cmpthese(
    1_000_000,
    {
        'use_a_loop'        =&gt; \&amp;use_a_loop,
        'direct_assignment' =&gt; \&amp;direct_assignment,
    }
);
</code></pre></div>

<p>Do you think the loop or the direct assignment is faster? Do you really care?
Well, it should be pretty clear that the loop is much easier to maintain. The
direct assignment, however ...</p>

<div class="shadow"><pre class="scrolled"><code>                       Rate        use_a_loop direct_assignment
use_a_loop         970874/s                --              -50%
direct_assignment 1923077/s               98%                --
</code></pre></div>

<p>Whoa! Directly assigning the data is twice as fast as the loop! If something
like that is at the bottom of a tight loop and benchmarking shows that it’s a
performance issue, then yes, switching from a loop to direct assignment might be
an idea, but that would kill <em>developer</em> performance when it comes to
maintaining that code. If you must do that, document it carefully, perhaps
including a snippet of the code that this replaces.</p>

<h3><a name="recommendation-5"></a>Recommendation</h3>

<p>Design the system well and don’t worry about performance while building it.
Doing so runs the risk of optimizing code that doesn’t need to be optimized and
possibly makes the code harder to maintain, raising long-term costs.</p>

<p>Instead, if your code is suffering performance issues, benchmark your code and
find out where the real problems are. Here’s a video of Tim Bunce explaining how
to profile your code:</p>

<div class="video-responsive">
    <iframe width="560" height="315" src="https://www.youtube.com/embed/SDWoCQf53Ck" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div>

<h1><a name="problems"></a>Problems</h1>

<h2><a name="too-many-responsibilities"></a>Too many responsibilities</h2>

<h2><a name="immutable"></a>Immutable</h2>

<h2><a name="accessors-for-attributes"></a>accessors for attributes</h2>

<h2><a name="namespaceautoclean-and-make-immutable"></a>namespace::autoclean and make_immutable</h2>

<h2><a name="consistent-return-types"></a>Consistent return types</h2>

<p>Return empty types [] {}</p>

<h2><a name="strict-constructor"></a>Strict constructor</h2>

<h2><a name="small-interfaces"></a>Small interfaces</h2>

<h2><a name="roles"></a>Roles</h2>

<pre><code>modifiers
abstract classes
</code></pre>

<h1><a name="dr-frankenstein"></a>Dr. Frankenstein</h1>

<p>If you’ve gotten this far, congrats! One thing very helpful with OO code is to
develop a set of guidelines on how you’ll build OO code and stick to it. We’re
going to be Dr. Frankenstein and build our own object system out of the parts we
have laying around. By ensuring everyone uses this object system, we can have
greater consistency in our code.</p>

<p>Let’s pretend you’ve settled on the Moose OOP system as the basis of your own.
You’d like to ensure several things are true (I’m not saying these are the best 
defaults, but this can get you started):</p>

<ul>
<li>Unknown arguments to the constructor are fatal</li>
<li>It should be easier to see which attributes are or are not required in the
constructor</li>
<li><code>namespace::autoclean</code> must always be used</li>
<li>You want signatures and types</li>
<li>The <code>Carp</code> module’s <code>carp</code>, <code>croak</code>, and <code>confess</code> functions should always be
present</li>
</ul>

<p>For this, you’ve decided that <code>param</code> should replace <code>has</code> if the parameter is
required in the constructor, and <code>field</code> should replace <code>has</code> if the parameter
is not allowed in the constructor. Let’s use
<a href="https://metacpan.org/pod/Moose::Exporter" target="_blank">Moose::Exporter</a> <span class="fa fa-external-link fa_custom"></span> to set this up.</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">package My::Personal::Moose;
package MooseX::Fields;

use 5.22.0;
use Moose                     ();
use MooseX::StrictConstructor ();
use Moose::Exporter;
use mro                  ();
use feature              ();
use namespace::autoclean ();
use Import::Into;
use Carp qw/carp croak confess/;

Moose::Exporter-&gt;setup_import_methods(
    with_meta =&gt; [ 'field', 'param' ],
    as_is     =&gt; [ \&amp;carp, \&amp;croak, \&amp;confess ],
    also      =&gt; ['Moose'],
);

sub init_meta {
    my ( $class, @args ) = @_;
    my %params    = @args;
    my $for_class = $params{for_class};
    Moose-&gt;init_meta(@args);
    MooseX::StrictConstructor-&gt;import( { into =&gt; $for_class } );
    warnings-&gt;unimport('experimental::signatures');
    feature-&gt;import(qw/signatures :5.22/);
    namespace::autoclean-&gt;import::into($for_class);

    # If we never use multiple inheritance, this should not be needed.
    mro::set_mro( scalar caller(), 'c3' );
}

sub field {
    my ( $meta, $name, %opts ) = @_;

    $opts{is} //= 'ro';

    # &quot;has [@attributes]&quot; versus &quot;has $attribute&quot;
    foreach my $attr ( 'ARRAY' eq ref $name ? @$name : $name ) {
        my %options = %opts;    # copy each time to avoid overwriting
        $options{init_arg} = undef;
        $meta-&gt;add_attribute( $attr, %options );
    }
}

sub param {
    my ( $meta, $name, %opts ) = @_;

    $opts{is}       //= 'ro';
    $opts{required} //= 1;

    # &quot;has [@attributes]&quot; versus &quot;has $attribute&quot;
    foreach my $attr ( 'ARRAY' eq ref $name ? @$name : $name ) {
        my %options = %opts;    # copy each time to avoid overwriting
        $options{init_arg} //= $attr;
        $meta-&gt;add_attribute( $attr, %options );
    }
}

1;
</code></pre></div>

<p>With that, and the <code>My::Personal::Types</code> above, here’s a (silly) example of how
to use this:</p>

<div class="shadow"><pre class="scrolled"><code class="language-perl">#!/usr/bin/env perl

use lib 'lib';
use Test::Most;

package My::Names {
    use v5.22.0;
    use My::Personal::Moose;
    use My::Personal::Types
      qw(compile Num NonEmptyStr Str PositiveInt ArrayRef);
    use List::Util 'sum'; # this gets removed my namespace::autoclean

    param _name   =&gt; ( isa =&gt; NonEmptyStr, init_arg =&gt; 'name' );
    param title   =&gt; ( isa =&gt; Str,         required =&gt; 0 );
    field created =&gt; ( isa =&gt; PositiveInt, default  =&gt; sub { time } );

    sub name ($self) {
        my $title = $self-&gt;title;
        my $name  = $self-&gt;_name;
        return $title ? &quot;$title $name&quot; : $name;
    }

    sub add ( $self, $args ) {
        state $check = compile( ArrayRef [Num] );
        ($args) = $check-&gt;($args);
        carp(&quot;no numbers supplied to add()&quot;) unless $args-&gt;@*;
        return sum( $args-&gt;@* );
    }

    sub warnit ($self) {
        carp(&quot;this is a warning&quot;);
    }

    __PACKAGE__-&gt;meta-&gt;make_immutable;
}

my $person = My::Names-&gt;new( name =&gt; 'Ovid', );
is $person-&gt;name, 'Ovid', 'name should be correct';
ok !defined $person-&gt;title, '... and no title';
cmp_ok $person-&gt;created, '&gt;', 0, '... and a sane default for created';
ok !$person-&gt;can('sum'), 'subroutines have been removed from the namespace';
is $person-&gt;add( [qw/1 3 5 6/] ), 15, 'Our add() method should work';
throws_ok { My::Names-&gt;new( name =&gt; 'Ovid', created =&gt; 1 ) }
'Moose::Exception',
  'Attributes not defined as `param` are illegal in the constructor';

my $doctor = My::Names-&gt;new( name =&gt; 'Smith', title =&gt; 'Dr.' );
is $doctor-&gt;name,        'Dr. Smith', 'Titles should show up correctly';
cmp_ok $doctor-&gt;created, '&gt;=',        $person-&gt;created,
  '... and their created date should be correct';

done_testing;
</code></pre></div>




          <p><strong>Please leave a comment below!</strong></p>



<hr>
    <div class="prevNext">
        
        <a href="/articles/why-is-object-oriented-programming-bad.html" class="prevPost">&laquo; Why is Object-Oriented Programming Bad?</a>
        
        <a href="/#" class="nextPost"></a>
    </div>

<hr>

          <p>If you'd like top-notch consulting or training, <a
          href="mailto:curtis.poe@gmail.com">email me</a> and let's discuss
          how I can help you. Read my <a href="/hireme.html">hire me</a> page
          to learn more about my background.</p>
        </div>
    </div>
<!-- End Document
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
    <div class="row">
      <div class="three columns">
        <p></p>
      </div>
      <div class="nine columns">
        <hr>
        <p>Copyright &copy; 2018-2022 by Curtis “Ovid” Poe.</p>
      </div>
    </div>
        <div id="disqus_thread"></div>
    <div class="row">
      <div class="twelve columns">
      
        <script>
        var disqus_config = function () {
            this.page.url        = "https://ovid.github.io/articles/common-problems-in-object-oriented-code.html";
            this.page.identifier = "articles/common-problems-in-object-oriented-code";
            this.page.title      = "Common Problems in Object-Oriented Code";
        };
        (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://https-ovid-github-io.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
        })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      
        </div>
    </div>
    </div>
    
    <script src="/static/js/prism.js"></script>
    
	
</body>
</html>


