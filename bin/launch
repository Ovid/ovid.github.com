#!/usr/bin/env perl

use v5.40;
use lib 'lib';
use Ovid::App::LiveEditor;
use Dancer2;
use Path::Tiny;
use Getopt::Long;
use Browser::Open;
use HTTP::Tiny;
use Time::HiRes qw(sleep);

my $port = 3000;

warn "DEBUG: Launching with args: @ARGV\n";

GetOptions(
    'port=i' => \$port,
) or die "Usage: $0 [--open] [--port=N] <file>\n";

my $file = shift @ARGV or die "Usage: $0 [--open] [--port=N] <file>\n";
warn "DEBUG: file=$file\n";
my $path = path($file)->absolute;
warn "DEBUG: path=$path\n";

# Auto-correct generated files to source files
# If user provides blog/foo.html, switch to root/blog/foo.tt
if ( $path =~ m{/(?:articles|blog)/.*\.html$} ) {
    my $root = path('.')->absolute;
    my $rel  = eval { $path->relative($root) };
    if ( !$@ && $rel !~ /^\.\./ ) {

        # Try .tt
        my $base_path = $root->child('root')->child($rel);
        my $try_tt    = $base_path->stringify;
        $try_tt =~ s/\.html$/.tt/;

        if ( -f $try_tt ) {
            my $p = path($try_tt);
            say STDERR "Notice: You provided a generated file. Switching to source file: " . $p->relative($root);
            $path = $p;
        }
        else {
            # Try .tt2markdown
            my $try_md = $try_tt . "2markdown";
            if ( -f $try_md ) {
                my $p = path($try_md);
                say STDERR "Notice: You provided a generated file. Switching to source file: " . $p->relative($root);
                $path = $p;
            }
        }
    }
}

die "File not found: $path\n" unless $path->exists;
die "Path is a directory, not a file: $path\n" if $path->is_dir;
die "File is not readable: $path\n" unless -r $path;

# Ensure file is within the project root (basic security check)
my $project_root = path('.')->absolute;
if ( $path->stringify !~ /^\Q$project_root\E/ ) {
    die "Security Error: Cannot edit files outside the project directory.\n";
}

$ENV{LIVE_EDITOR_FILE} = $path->stringify;

# Security: Bind to localhost only
set host => '127.0.0.1';
set port => $port;

my $pid = fork();
warn "DEBUG: fork returned " . ( defined $pid ? $pid : "undef" ) . "\n";
if ( !defined $pid ) {
    warn "Failed to fork for browser launch: $!";
}
elsif ( $pid == 0 ) {

    # Child process
    if ( open my $fh, '>>', 'child_debug.log' ) { print $fh "Child $$ started\n"; close $fh; }

    my $url        = "http://127.0.0.1:$port/";
    my $health_url = "http://127.0.0.1:$port/health";
    my $http       = HTTP::Tiny->new( timeout => 1 );

    # Poll for server readiness
    my $max_retries = 50;    # 5 seconds
    for ( 1 .. $max_retries ) {
        warn "DEBUG: loop $_\n";
        my $resp = $http->get($health_url);
        if ( $resp->{success} ) {
            my $err = Browser::Open::open_browser($url);
            if ( defined $err ) {
                warn "Failed to open browser: exit code $err";
            }
            exit 0;
        }
        sleep 0.1;
    }
    warn "Server did not become ready in time (5s). Open $url manually.";
    exit 0;
}

# Parent continues to start server

dance;

