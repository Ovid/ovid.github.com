# JavaScript API Contract: collapsible.js

**Feature**: 004-collapsible-sections  
**Version**: 1.0.0  
**Date**: 2025-11-16  
**File**: `static/js/collapsible.js`

## Module Overview

Vanilla JavaScript module that provides interactive expand/collapse functionality for collapsible sections. Zero external dependencies.

## Public API

### Initialization

**Function**: Auto-initializes on DOM ready

**Trigger**: 
- `DOMContentLoaded` event (if document still loading)
- Immediate execution (if document already loaded)

**Behavior**:
```javascript
// Finds all .collapsible-trigger elements
// Attaches event listeners for click and keyboard interaction
// Idempotent: safe to call multiple times
```

**No manual initialization required** - the module self-initializes.

## Event Handling

### Click Event

**Selector**: `.collapsible-trigger`

**Event**: `click`

**Handler**: `toggleCollapsible()`

**Behavior**:
1. Prevents default action
2. Reads `aria-controls` attribute to find content element
3. Reads current `aria-expanded` state
4. Toggles state and updates DOM

### Keyboard Event

**Selector**: `.collapsible-trigger`

**Event**: `keydown`

**Keys**: `Enter` or `Space` (` `)

**Handler**: `toggleCollapsible()`

**Behavior**:
1. Prevents default scroll (for Space key)
2. Same behavior as click event
3. Ensures keyboard accessibility

## State Management

### DOM State Updates

When `toggleCollapsible()` is called:

```javascript
function toggleCollapsible(e) {
    // 1. Read current state
    const contentId = this.getAttribute('aria-controls');
    const content = document.getElementById(contentId);
    const isExpanded = this.getAttribute('aria-expanded') === 'true';
    
    // 2. Toggle ARIA state
    this.setAttribute('aria-expanded', !isExpanded);
    
    // 3. Toggle content visibility
    content.classList.toggle('expanded');
    
    // 4. Update icon
    const icon = this.querySelector('.collapsible-icon');
    icon.classList.toggle('fa-chevron-down');
    icon.classList.toggle('fa-chevron-up');
}
```

### State Transitions

| Current State | Action | New State | DOM Changes |
|--------------|--------|-----------|-------------|
| Collapsed | Click/Enter/Space | Expanded | `aria-expanded="false"` → `"true"`<br>Add `.expanded` class<br>Icon: `fa-chevron-down` → `fa-chevron-up` |
| Expanded | Click/Enter/Space | Collapsed | `aria-expanded="true"` → `"false"`<br>Remove `.expanded` class<br>Icon: `fa-chevron-up` → `fa-chevron-down` |

## Error Handling

### Missing Content Element

**Condition**: `document.getElementById(contentId)` returns `null`

**Behavior**:
```javascript
if (!content) {
    console.warn(`Collapsible content not found: ${contentId}`);
    return; // Skip this trigger
}
```

**Effect**: Other triggers on the page continue to work normally.

### Missing Icon Element

**Condition**: `.querySelector('.collapsible-icon')` returns `null`

**Behavior**: Silently continues without updating icon (state still toggles)

**Rationale**: Icon is visual enhancement; core functionality shouldn't break if missing.

## HTML Contract Requirements

### Required HTML Structure

The JavaScript expects HTML generated by `Template::Plugin::Ovid.collapse()`:

```html
<div class="collapsible-trigger"
     id="collapsible-trigger-1"
     aria-controls="collapsible-content-1"
     aria-expanded="false">
    <i class="collapsible-icon fa fa-chevron-down"></i>
    <span>Short description</span>
</div>

<div id="collapsible-content-1" class="collapsible-content">
    Full content here
</div>
```

### Required Attributes

| Element | Attribute | Purpose |
|---------|-----------|---------|
| `.collapsible-trigger` | `id` | Optional (for aria-labelledby) |
| `.collapsible-trigger` | `aria-controls` | REQUIRED: Points to content element ID |
| `.collapsible-trigger` | `aria-expanded` | REQUIRED: Initial state ("false") |
| `.collapsible-content` | `id` | REQUIRED: Matches aria-controls value |

### Required CSS Classes

| Element | Class | Purpose |
|---------|-------|---------|
| Trigger | `.collapsible-trigger` | Selector for attaching events |
| Icon | `.collapsible-icon` | Optional selector for icon updates |
| Content | `.collapsible-content` | Selector for content element |
| Content (when expanded) | `.expanded` | Added/removed to show/hide content |

## CSS Integration Contract

The JavaScript relies on CSS for visual presentation:

```css
/* Initial state: hidden */
.collapsible-content {
    display: none;
}

/* Expanded state: visible */
.collapsible-content.expanded {
    display: block;
}
```

**JavaScript does NOT**:
- Set inline styles (`element.style.display`)
- Manage animations/transitions
- Calculate heights or positions

**JavaScript ONLY**:
- Toggles `.expanded` class
- Updates ARIA attributes
- Swaps icon classes

## Browser Compatibility

### Required APIs

| API | Minimum Version | Fallback |
|-----|-----------------|----------|
| `querySelectorAll()` | All modern browsers | None (required) |
| `addEventListener()` | All modern browsers | None (required) |
| `classList.toggle()` | All modern browsers | None (required) |
| `getAttribute()`/`setAttribute()` | All modern browsers | None (required) |

### Supported Browsers

- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

**Not Supported**: IE11 (per project requirements)

## Performance Characteristics

### Initialization Cost

- **DOM Queries**: One `querySelectorAll('.collapsible-trigger')` per page load
- **Event Listeners**: Two per trigger (click + keydown)
- **Memory**: ~100 bytes per trigger (event listener overhead)

### Runtime Cost

- **Toggle Operation**: O(1) - constant time
- **DOM Updates**: 4-5 attribute/class changes per toggle
- **Reflows**: Minimal (only content visibility change)

### Optimization

- Event listeners attached to individual triggers (no delegation)
- Rationale: Collapsible sections are static after page load
- Alternative (event delegation) not needed for this use case

## Testing Contract

### Unit Tests (JavaScript)

```javascript
// Test framework: Jest, Mocha, or similar

describe('Collapsible.js', () => {
    it('should initialize on DOMContentLoaded', () => {
        // Verify event listeners attached
    });
    
    it('should toggle aria-expanded on click', () => {
        // Click trigger, verify attribute change
    });
    
    it('should toggle .expanded class on click', () => {
        // Click trigger, verify class added/removed
    });
    
    it('should update icon classes', () => {
        // Verify chevron-down/up toggle
    });
    
    it('should handle Enter key', () => {
        // Simulate keydown, verify toggle
    });
    
    it('should handle Space key', () => {
        // Simulate keydown, verify toggle
    });
    
    it('should handle missing content gracefully', () => {
        // Verify console.warn, no error thrown
    });
});
```

### Integration Tests

1. Render page with collapsible sections
2. Verify JavaScript loads without errors
3. Click trigger, verify content appears
4. Click again, verify content hides
5. Use keyboard navigation (Tab, Enter, Space)
6. Test multiple sections independently
7. Test with screen reader (manual)

### Accessibility Tests

**Automated**:
- axe-core: Verify ARIA attributes valid
- WAVE: Check keyboard navigation

**Manual**:
- NVDA: Verify state announcements
- JAWS: Verify focus management
- VoiceOver: Verify labeling correct

## Integration with HTML Generation

### Template::Plugin::Ovid Expectations

The Perl module MUST generate:
1. Correct `aria-controls` linking trigger to content
2. Initial `aria-expanded="false"` on all triggers
3. Unique IDs for all content elements
4. Correct CSS classes on all elements

### Wrapper Template Expectations

The `include/wrapper.html` template MUST:
1. Include `<script src="/static/js/collapsible.js"></script>` before `</body>`
2. Include AFTER any polyfills or framework scripts
3. Include AFTER DOM content is present

**Correct Order**:
```html
<body>
    <!-- Page content with collapsible sections -->
    
    <!-- Other scripts -->
    <script src="/static/js/other.js"></script>
    
    <!-- Collapsible script (last) -->
    <script src="/static/js/collapsible.js"></script>
</body>
```

## Configuration

**No configuration options** - the module is self-contained and requires no setup.

**Rationale**: Keeps implementation simple and follows "convention over configuration" principle.

## Extensibility

### Custom Event Dispatching (Future)

Could dispatch custom events for advanced integrations:

```javascript
// Future enhancement (not in v1.0.0)
content.dispatchEvent(new CustomEvent('collapsible:toggle', {
    detail: { expanded: !isExpanded }
}));
```

**Use Cases**:
- Analytics tracking
- Synchronized collapsibles (accordion behavior)
- Custom animations

**Status**: Out of scope for initial implementation

### Animation Hooks (Future)

Could add CSS classes for animation states:

```javascript
// Future enhancement (not in v1.0.0)
content.classList.add('expanding');
setTimeout(() => content.classList.add('expanded'), 300);
```

**Status**: Out of scope (spec explicitly excludes animations)

## Security Considerations

### DOM Manipulation Safety

- Uses `textContent` for reading (safe)
- Uses `classList` API (safe from injection)
- Uses `setAttribute` with controlled values (safe)
- Never uses `innerHTML` or `eval`

### XSS Prevention

The JavaScript does NOT:
- Insert user content into DOM
- Execute dynamic code
- Parse HTML strings
- Use `eval()` or `Function()`

**All content** comes from server-rendered HTML (generated by trusted Perl code).

## Versioning

**Current Version**: 1.0.0

**Breaking Changes**:
- Changing CSS class names → Major version
- Changing event handling behavior → Major version
- Changing HTML structure requirements → Major version
- Bug fixes → Patch version

## Dependencies

**Zero dependencies** - pure vanilla JavaScript.

**Rationale**: 
- Constitution Principle V: Zero external service dependencies
- Minimizes page weight
- Improves load time
- Reduces security surface area

## Summary

The `collapsible.js` module provides:
- Automatic initialization on page load
- Click and keyboard event handling
- ARIA state management
- Icon class toggling
- Graceful error handling
- Zero external dependencies
- Browser compatibility with modern browsers
- Accessibility compliance (WCAG 2.1 AA)

All behavior aligns with HTML/CSS contracts and Constitution principles.
